"use strict";

var __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {
  if (k2 === undefined) k2 = k;
  Object.defineProperty(o, k2, {
    enumerable: true,
    get: function () {
      return m[k];
    }
  });
} : function (o, m, k, k2) {
  if (k2 === undefined) k2 = k;
  o[k2] = m[k];
});

var __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {
  Object.defineProperty(o, "default", {
    enumerable: true,
    value: v
  });
} : function (o, v) {
  o["default"] = v;
});

var __importStar = this && this.__importStar || function (mod) {
  if (mod && mod.__esModule) return mod;
  var result = {};
  if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);

  __setModuleDefault(result, mod);

  return result;
};

var __spreadArray = this && this.__spreadArray || function (to, from) {
  for (var i = 0, il = from.length, j = to.length; i < il; i++, j++) to[j] = from[i];

  return to;
};

var __importDefault = this && this.__importDefault || function (mod) {
  return mod && mod.__esModule ? mod : {
    "default": mod
  };
};

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validate = exports.ValidatorRegistry = void 0;

var utils_1 = require("../utils");

var Validators = __importStar(require("./Validators"));

var constants_1 = require("./constants");

var Validator_1 = __importDefault(require("./Validators/Validator"));

function ValRegistry() {
  var initial = [];

  for (var _i = 0; _i < arguments.length; _i++) {
    initial[_i] = arguments[_i];
  }

  var registry = new function () {
    var cache = {};
    var self = this;

    self.register = function () {
      var validator = [];

      for (var _i = 0; _i < arguments.length; _i++) {
        validator[_i] = arguments[_i];
      }

      validator.forEach(function (v) {
        if (v instanceof Validator_1.default) {
          cache[v.validationKey] = v;
        } else {
          var constructorMethod = v.default || v;
          var instance = new constructorMethod();
          cache[instance.validationKey] = instance;
        }
      });
    };

    self.getValidator = function (validatorKey) {
      if (!(validatorKey in cache)) return;
      return cache[validatorKey];
    };
  }();
  registry.register.apply(registry, initial);
  return registry;
}

exports.ValidatorRegistry = ValRegistry.apply(void 0, Object.values(Validators));

function validate(obj) {
  var decoratedProperties = [];

  for (var prop in obj) if (obj.hasOwnProperty(prop)) decoratedProperties.push(utils_1.getPropertyDecorators(constants_1.ValidationKeys.REFLECT, obj, prop));

  return decoratedProperties.reduce(function (accum, decoratedProperty) {
    var prop = decoratedProperty.prop,
        decorators = decoratedProperty.decorators;
    if (!decorators || !decorators.length) return accum;
    var errs = decorators.reduce(function (acc, decorator) {
      var validator = exports.ValidatorRegistry.getValidator(decorator.key);

      if (!validator) {
        throw new Error("Could not find Matching validator for " + decorator.key + " for property " + String(decoratedProperty.prop));
      }

      var err = validator.hasErrors.apply(validator, __spreadArray([obj[prop]], Object.values(decorator.props)));

      if (err) {
        acc = acc || {};
        acc[decorator.key] = err;
      }

      return acc;
    }, undefined);

    if (errs) {
      var propErrors = {
        property: decoratedProperty.prop,
        errors: errs
      };
      accum = accum || [];
      accum.push(propErrors);
    }

    return accum;
  }, undefined);
}

exports.validate = validate;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZhbGlkYXRpb24vdmFsaWRhdGlvbi5qcyIsInZhbGlkYXRpb24vdmFsaWRhdGlvbi50cyJdLCJuYW1lcyI6WyJfX2NyZWF0ZUJpbmRpbmciLCJPYmplY3QiLCJjcmVhdGUiLCJvIiwibSIsImsiLCJrMiIsInVuZGVmaW5lZCIsImRlZmluZVByb3BlcnR5IiwiZW51bWVyYWJsZSIsImdldCIsIl9fc2V0TW9kdWxlRGVmYXVsdCIsInYiLCJ2YWx1ZSIsIl9faW1wb3J0U3RhciIsIm1vZCIsIl9fZXNNb2R1bGUiLCJyZXN1bHQiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJfX3NwcmVhZEFycmF5IiwidG8iLCJmcm9tIiwiaSIsImlsIiwibGVuZ3RoIiwiaiIsIl9faW1wb3J0RGVmYXVsdCIsImV4cG9ydHMiLCJ2YWxpZGF0ZSIsIlZhbGlkYXRvclJlZ2lzdHJ5IiwidXRpbHNfMSIsInJlcXVpcmUiLCJWYWxpZGF0b3JzIiwiY29uc3RhbnRzXzEiLCJWYWxpZGF0b3JfMSIsIlZhbFJlZ2lzdHJ5IiwiaW5pdGlhbCIsIl9pIiwiYXJndW1lbnRzIiwicmVnaXN0cnkiLCJjYWNoZSIsInNlbGYiLCJyZWdpc3RlciIsInZhbGlkYXRvciIsImZvckVhY2giLCJkZWZhdWx0IiwidmFsaWRhdGlvbktleSIsImNvbnN0cnVjdG9yTWV0aG9kIiwiaW5zdGFuY2UiLCJnZXRWYWxpZGF0b3IiLCJ2YWxpZGF0b3JLZXkiLCJhcHBseSIsInZhbHVlcyIsIm9iaiIsImRlY29yYXRlZFByb3BlcnRpZXMiLCJwcm9wIiwicHVzaCIsImdldFByb3BlcnR5RGVjb3JhdG9ycyIsIlZhbGlkYXRpb25LZXlzIiwiUkVGTEVDVCIsInJlZHVjZSIsImFjY3VtIiwiZGVjb3JhdGVkUHJvcGVydHkiLCJkZWNvcmF0b3JzIiwiZXJycyIsImFjYyIsImRlY29yYXRvciIsImtleSIsIkVycm9yIiwiU3RyaW5nIiwiZXJyIiwiaGFzRXJyb3JzIiwicHJvcHMiLCJwcm9wRXJy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SDs7QUFFRCxhQUFPTCxHQUFQO0FBQ0gsS0FoQlksRUFnQlY1RCxTQWhCVSxDQUFiOztBQWtCQSxRQUFJMkQsSUFBSixFQUFTO0FBQ0wsVUFBTVMsVUFBVSxHQUFHO0FBQ2ZDLFFBQUFBLFFBQVEsRUFBRVosaUJBQWlCLENBQUNQLElBRGI7QUFFZm9CLFFBQUFBLE1BQU0sRUFBRVg7QUFGTyxPQUFuQjtBQUtBSCxNQUFBQSxLQUFLLEdBQUdBLEtBQUssSUFBSSxFQUFqQjtBQUVBQSxNQUFBQSxLQUFLLENBQUNMLElBQU4sQ0FBV2lCLFVBQVg7QUFDSDs7QUFFRCxXQUFPWixLQUFQO0FBQ0gsR0FuQ00sRUFtQ0p4RCxTQW5DSSxDQUFQO0FBb0NIOztBQTFDRHNCLE9BQUEsQ0FBQUMsUUFBQSxHQUFBQSxRQUFBIiwiZmlsZSI6InZhbGlkYXRpb24vdmFsaWRhdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xudmFyIF9fY3JlYXRlQmluZGluZyA9ICh0aGlzICYmIHRoaXMuX19jcmVhdGVCaW5kaW5nKSB8fCAoT2JqZWN0LmNyZWF0ZSA/IChmdW5jdGlvbihvLCBtLCBrLCBrMikge1xuICAgIGlmIChrMiA9PT0gdW5kZWZpbmVkKSBrMiA9IGs7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBtW2tdOyB9IH0pO1xufSkgOiAoZnVuY3Rpb24obywgbSwgaywgazIpIHtcbiAgICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrO1xuICAgIG9bazJdID0gbVtrXTtcbn0pKTtcbnZhciBfX3NldE1vZHVsZURlZmF1bHQgPSAodGhpcyAmJiB0aGlzLl9fc2V0TW9kdWxlRGVmYXVsdCkgfHwgKE9iamVjdC5jcmVhdGUgPyAoZnVuY3Rpb24obywgdikge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBcImRlZmF1bHRcIiwgeyBlbnVtZXJhYmxlOiB0cnVlLCB2YWx1ZTogdiB9KTtcbn0pIDogZnVuY3Rpb24obywgdikge1xuICAgIG9bXCJkZWZhdWx0XCJdID0gdjtcbn0pO1xudmFyIF9faW1wb3J0U3RhciA9ICh0aGlzICYmIHRoaXMuX19pbXBvcnRTdGFyKSB8fCBmdW5jdGlvbiAobW9kKSB7XG4gICAgaWYgKG1vZCAmJiBtb2QuX19lc01vZHVsZSkgcmV0dXJuIG1vZDtcbiAgICB2YXIgcmVzdWx0ID0ge307XG4gICAgaWYgKG1vZCAhPSBudWxsKSBmb3IgKHZhciBrIGluIG1vZCkgaWYgKGsgIT09IFwiZGVmYXVsdFwiICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChtb2QsIGspKSBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGspO1xuICAgIF9fc2V0TW9kdWxlRGVmYXVsdChyZXN1bHQsIG1vZCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn07XG52YXIgX19zcHJlYWRBcnJheSA9ICh0aGlzICYmIHRoaXMuX19zcHJlYWRBcnJheSkgfHwgZnVuY3Rpb24gKHRvLCBmcm9tKSB7XG4gICAgZm9yICh2YXIgaSA9IDAsIGlsID0gZnJvbS5sZW5ndGgsIGogPSB0by5sZW5ndGg7IGkgPCBpbDsgaSsrLCBqKyspXG4gICAgICAgIHRvW2pdID0gZnJvbVtpXTtcbiAgICByZXR1cm4gdG87XG59O1xudmFyIF9faW1wb3J0RGVmYXVsdCA9ICh0aGlzICYmIHRoaXMuX19pbXBvcnREZWZhdWx0KSB8fCBmdW5jdGlvbiAobW9kKSB7XG4gICAgcmV0dXJuIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpID8gbW9kIDogeyBcImRlZmF1bHRcIjogbW9kIH07XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuZXhwb3J0cy52YWxpZGF0ZSA9IGV4cG9ydHMuVmFsaWRhdG9yUmVnaXN0cnkgPSB2b2lkIDA7XG52YXIgdXRpbHNfMSA9IHJlcXVpcmUoXCIuLi91dGlsc1wiKTtcbnZhciBWYWxpZGF0b3JzID0gX19pbXBvcnRTdGFyKHJlcXVpcmUoXCIuL1ZhbGlkYXRvcnNcIikpO1xudmFyIGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4vY29uc3RhbnRzXCIpO1xudmFyIFZhbGlkYXRvcl8xID0gX19pbXBvcnREZWZhdWx0KHJlcXVpcmUoXCIuL1ZhbGlkYXRvcnMvVmFsaWRhdG9yXCIpKTtcbmZ1bmN0aW9uIFZhbFJlZ2lzdHJ5KCkge1xuICAgIHZhciBpbml0aWFsID0gW107XG4gICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcbiAgICAgICAgaW5pdGlhbFtfaV0gPSBhcmd1bWVudHNbX2ldO1xuICAgIH1cbiAgICB2YXIgcmVnaXN0cnkgPSBuZXcgZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgY2FjaGUgPSB7fTtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgICAgICBzZWxmLnJlZ2lzdGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IFtdO1xuICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHtcbiAgICAgICAgICAgICAgICB2YWxpZGF0b3JbX2ldID0gYXJndW1lbnRzW19pXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhbGlkYXRvci5mb3JFYWNoKGZ1bmN0aW9uICh2KSB7XG4gICAgICAgICAgICAgICAgaWYgKHYgaW5zdGFuY2VvZiBWYWxpZGF0b3JfMS5kZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNhY2hlW3YudmFsaWRhdGlvbktleV0gPSB2O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnN0cnVjdG9yTWV0aG9kID0gdi5kZWZhdWx0IHx8IHY7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5ldyBjb25zdHJ1Y3Rvck1ldGhvZCgpO1xuICAgICAgICAgICAgICAgICAgICBjYWNoZVtpbnN0YW5jZS52YWxpZGF0aW9uS2V5XSA9IGluc3RhbmNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBzZWxmLmdldFZhbGlkYXRvciA9IGZ1bmN0aW9uICh2YWxpZGF0b3JLZXkpIHtcbiAgICAgICAgICAgIGlmICghKHZhbGlkYXRvcktleSBpbiBjYWNoZSkpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgcmV0dXJuIGNhY2hlW3ZhbGlkYXRvcktleV07XG4gICAgICAgIH07XG4gICAgfSgpO1xuICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyLmFwcGx5KHJlZ2lzdHJ5LCBpbml0aWFsKTtcbiAgICByZXR1cm4gcmVnaXN0cnk7XG59XG5leHBvcnRzLlZhbGlkYXRvclJlZ2lzdHJ5ID0gVmFsUmVnaXN0cnkuYXBwbHkodm9pZCAwLCBPYmplY3QudmFsdWVzKFZhbGlkYXRvcnMpKTtcbmZ1bmN0aW9uIHZhbGlkYXRlKG9iaikge1xuICAgIHZhciBkZWNvcmF0ZWRQcm9wZXJ0aWVzID0gW107XG4gICAgZm9yICh2YXIgcHJvcCBpbiBvYmopXG4gICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkocHJvcCkpXG4gICAgICAgICAgICBkZWNvcmF0ZWRQcm9wZXJ0aWVzLnB1c2godXRpbHNfMS5nZXRQcm9wZXJ0eURlY29yYXRvcnMoY29uc3RhbnRzXzEuVmFsaWRhdGlvbktleXMuUkVGTEVDVCwgb2JqLCBwcm9wKSk7XG4gICAgcmV0dXJuIGRlY29yYXRlZFByb3BlcnRpZXMucmVkdWNlKGZ1bmN0aW9uIChhY2N1bSwgZGVjb3JhdGVkUHJvcGVydHkpIHtcbiAgICAgICAgdmFyIHByb3AgPSBkZWNvcmF0ZWRQcm9wZXJ0eS5wcm9wLCBkZWNvcmF0b3JzID0gZGVjb3JhdGVkUHJvcGVydHkuZGVjb3JhdG9ycztcbiAgICAgICAgaWYgKCFkZWNvcmF0b3JzIHx8ICFkZWNvcmF0b3JzLmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybiBhY2N1bTtcbiAgICAgICAgdmFyIGVycnMgPSBkZWNvcmF0b3JzLnJlZHVjZShmdW5jdGlvbiAoYWNjLCBkZWNvcmF0b3IpIHtcbiAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBleHBvcnRzLlZhbGlkYXRvclJlZ2lzdHJ5LmdldFZhbGlkYXRvcihkZWNvcmF0b3Iua2V5KTtcbiAgICAgICAgICAgIGlmICghdmFsaWRhdG9yKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ291bGQgbm90IGZpbmQgTWF0Y2hpbmcgdmFsaWRhdG9yIGZvciBcIiArIGRlY29yYXRvci5rZXkgKyBcIiBmb3IgcHJvcGVydHkgXCIgKyBTdHJpbmcoZGVjb3JhdGVkUHJvcGVydHkucHJvcCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGVyciA9IHZhbGlkYXRvci5oYXNFcnJvcnMuYXBwbHkodmFsaWRhdG9yLCBfX3NwcmVhZEFycmF5KFtvYmpbcHJvcF1dLCBPYmplY3QudmFsdWVzKGRlY29yYXRvci5wcm9wcykpKTtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBhY2MgPSBhY2MgfHwge307XG4gICAgICAgICAgICAgICAgYWNjW2RlY29yYXRvci5rZXldID0gZXJyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfSwgdW5kZWZpbmVkKTtcbiAgICAgICAgaWYgKGVycnMpIHtcbiAgICAgICAgICAgIHZhciBwcm9wRXJyb3JzID0ge1xuICAgICAgICAgICAgICAgIHByb3BlcnR5OiBkZWNvcmF0ZWRQcm9wZXJ0eS5wcm9wLFxuICAgICAgICAgICAgICAgIGVycm9yczogZXJyc1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGFjY3VtID0gYWNjdW0gfHwgW107XG4gICAgICAgICAgICBhY2N1bS5wdXNoKHByb3BFcnJvcnMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2N1bTtcbiAgICB9LCB1bmRlZmluZWQpO1xufVxuZXhwb3J0cy52YWxpZGF0ZSA9IHZhbGlkYXRlOyIsImltcG9ydCBNb2RlbCBmcm9tIFwiLi4vTW9kZWwvTW9kZWxcIjtcbmltcG9ydCB7RXJyb3JzLCBSZWdpc3RyeX0gZnJvbSBcIi4vdHlwZXNcIjtcbmltcG9ydCB7Z2V0UHJvcGVydHlEZWNvcmF0b3JzfSBmcm9tICcuLi91dGlscydcbmltcG9ydCAqIGFzIFZhbGlkYXRvcnMgZnJvbSAnLi9WYWxpZGF0b3JzJ1xuaW1wb3J0IHtWYWxpZGF0aW9uS2V5c30gZnJvbSBcIi4vY29uc3RhbnRzXCI7XG5pbXBvcnQgVmFsaWRhdG9yIGZyb20gXCIuL1ZhbGlkYXRvcnMvVmFsaWRhdG9yXCI7XG5cbi8qKlxuICogUmV0dXJuc1xuICogQHJldHVybiB7Kn1cbiAqIEBjb25zdHJ1Y3RvclxuICogQGZ1bmN0aW9uIFZhbFJlZ2lzdHJ5XG4gKiBAbWVtYmVyT2YgVmFsaWRhdGlvblxuICovXG5mdW5jdGlvbiBWYWxSZWdpc3RyeSguLi5pbml0aWFsOiBhbnlbXSkgOiBSZWdpc3RyeSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IHJlZ2lzdHJ5OiBSZWdpc3RyeSA9ICBuZXcgZnVuY3Rpb24oKXtcbiAgICAgICAgY29uc3QgY2FjaGU6IGFueSA9IHt9O1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IHNlbGY6IGFueSA9IHRoaXM7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqXG4gICAgICAgICAqIEBwYXJhbSB2YWxpZGF0b3JcbiAgICAgICAgICogQG1lbWJlck9mIFZhbGlkYXRvclJlZ2lzdHJ5XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnJlZ2lzdGVyID0gZnVuY3Rpb24oLi4udmFsaWRhdG9yOiBhbnlbXSkgOiB2b2lke1xuICAgICAgICAgICAgdmFsaWRhdG9yLmZvckVhY2godiA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHYgaW5zdGFuY2VvZiBWYWxpZGF0b3Ipe1xuICAgICAgICAgICAgICAgICAgICBjYWNoZVt2LnZhbGlkYXRpb25LZXldID0gdjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbnN0cnVjdG9yTWV0aG9kID0gdi5kZWZhdWx0IHx8IHY7XG4gICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdGFuY2U6IFZhbGlkYXRvciA9IG5ldyBjb25zdHJ1Y3Rvck1ldGhvZCgpO1xuICAgICAgICAgICAgICAgICAgICBjYWNoZVtpbnN0YW5jZS52YWxpZGF0aW9uS2V5XSA9IGluc3RhbmNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqXG4gICAgICAgICAqIEBwYXJhbSB2YWxpZGF0b3JLZXlcbiAgICAgICAgICogQHJldHVybiB7Kn1cbiAgICAgICAgICogQG1lbWJlck9mIFZhbGlkYXRvclJlZ2lzdHJ5XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLmdldFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbGlkYXRvcktleTogc3RyaW5nKXtcbiAgICAgICAgICAgIGlmICghKHZhbGlkYXRvcktleSBpbiBjYWNoZSkpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgcmV0dXJuIGNhY2hlW3ZhbGlkYXRvcktleV07XG4gICAgICAgIH1cbiAgICB9KClcbiAgICByZWdpc3RyeS5yZWdpc3RlciguLi5pbml0aWFsKTtcbiAgICByZXR1cm4gcmVnaXN0cnk7XG59XG5cbi8qKlxuICogQGNvbnN0YW50XG4gKiBAbWVtYmVyT2YgVmFsaWRhdGlvblxuICovXG5leHBvcnQgY29uc3QgVmFsaWRhdG9yUmVnaXN0cnkgPSBWYWxSZWdpc3RyeSguLi5PYmplY3QudmFsdWVzKFZhbGlkYXRvcnMpKTtcblxuLyoqXG4gKiBBbmFseXNlcyB0aGUgZGVjb3JhdGlvbnMgb2YgdGhlIHByb3BlcnRpZXMgYW5kIHZhbGlkYXRlcyB0aGUgb2JqIGFjY29yZGluZyB0byB0aGVtXG4gKiBAZnVuY3Rpb24gdmFsaWRhdGVcbiAqIEBtZW1iZXJPZiBWYWxpZGF0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZTxUIGV4dGVuZHMgTW9kZWw+KG9iajogVCkgOiBFcnJvcnN7XG4gICAgY29uc3QgZGVjb3JhdGVkUHJvcGVydGllcyA9IFtdO1xuICAgIGZvciAobGV0IHByb3AgaW4gb2JqKVxuICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KHByb3ApKVxuICAgICAgICAgICAgZGVjb3JhdGVkUHJvcGVydGllcy5wdXNoKGdldFByb3BlcnR5RGVjb3JhdG9ycyhWYWxpZGF0aW9uS2V5cy5SRUZMRUNULCBvYmosIHByb3ApKTtcblxuICAgIHJldHVybiBkZWNvcmF0ZWRQcm9wZXJ0aWVzLnJlZHVjZSgoYWNjdW0sIGRlY29yYXRlZFByb3BlcnR5KSA9PiB7XG4gICAgICAgIGNvbnN0IHtwcm9wLCBkZWNvcmF0b3JzfSA9IGRlY29yYXRlZFByb3BlcnR5O1xuICAgICAgICBpZiAoIWRlY29yYXRvcnMgfHwgIWRlY29yYXRvcnMubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuIGFjY3VtO1xuXG4gICAgICAgIGNvbnN0IGVycnMgPSBkZWNvcmF0b3JzLnJlZHVjZSgoYWNjLCBkZWNvcmF0b3I6IHtrZXk6IHN0cmluZywgcHJvcHM6IHt9fSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsaWRhdG9yID0gVmFsaWRhdG9yUmVnaXN0cnkuZ2V0VmFsaWRhdG9yKGRlY29yYXRvci5rZXkpO1xuICAgICAgICAgICAgaWYgKCF2YWxpZGF0b3Ipe1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgTWF0Y2hpbmcgdmFsaWRhdG9yIGZvciAke2RlY29yYXRvci5rZXl9IGZvciBwcm9wZXJ0eSAke1N0cmluZyhkZWNvcmF0ZWRQcm9wZXJ0eS5wcm9wKX1gKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBjb25zdCBlcnIgPSB2YWxpZGF0b3IuaGFzRXJyb3JzKG9ialtwcm9wXSwgLi4uT2JqZWN0LnZhbHVlcyhkZWNvcmF0b3IucHJvcHMpKTtcbiAgICAgICAgICAgIGlmIChlcnIpe1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBhY2MgPSBhY2MgfHwge307XG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgIGFjY1tkZWNvcmF0b3Iua2V5XSA9IGVycjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfSwgdW5kZWZpbmVkKTtcblxuICAgICAgICBpZiAoZXJycyl7XG4gICAgICAgICAgICBjb25zdCBwcm9wRXJyb3JzID0ge1xuICAgICAgICAgICAgICAgIHByb3BlcnR5OiBkZWNvcmF0ZWRQcm9wZXJ0eS5wcm9wLFxuICAgICAgICAgICAgICAgIGVycm9yczogZXJyc1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgYWNjdW0gPSBhY2N1bSB8fCBbXTtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGFjY3VtLnB1c2gocHJvcEVycm9ycyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYWNjdW07XG4gICAgfSwgdW5kZWZpbmVkKTtcbn0iXX0=
